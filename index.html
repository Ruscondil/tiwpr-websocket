<!DOCTYPE html>
<html>

<head>
    <title>Room Creator</title>
</head>

<body>
    <div id="roomCreator">
        <h1>Room Creator</h1>
        <input id="roomNameCreator" type="text" placeholder="Enter room name" maxlength="16">
        <button id="createRoom">Create Room</button>
        <h2>Rooms</h2>
        <ul id="roomList"></ul>
    </div>
    <div id="roomView" style="display: none;">
        <div>
            <h1>Room</h1>
            <h2 id="roomNameView">Room name goes here</h2>
            <p id="players">Players go here</p>
            <button id="D" style="display: none;">Delete room</button>
            <button id="startGameButton" style="display: none;">Start Game</button>
        </div>
    </div>
    <div id="gameView" style="display: none;">
        <div>
            <h1>Game</h1>
            <p id="wordProgress">Word: </p>
            <p id="wrongLetters">Wrong letters: </p>

            <div id="letters" style="display: none;">
                <input id="letterInput" type="text" placeholder="Enter letter" maxlength="1">
                <button id="sendLetter">Send</button>
            </div>
            <p id="W">Wait for your turn</p>
            <canvas id="hangmanCanvas" width="200" height="200" style="border:1px solid #d3d3d3;">
                Your browser does not support the HTML canvas tag.
            </canvas>


        </div>
    </div>
    <div id="EndGame" style="display: none;">
        <h1>Game Over</h1>
        <p id="EndGameMessage">Game Over</p>
        <button id="EndGameButton">Back to menu</button>
    </div>

    <script>
        var socket = new WebSocket("ws://localhost:8765");
        var roomList = document.getElementById('roomList');

        document.getElementById('createRoom').addEventListener('click', function () {
            var roomName = document.getElementById('roomNameCreator').value;
            if (roomName === '') {
                alert('Room name cannot be empty');
            } else {
                sendActionRoomData('X', roomName);
            }
            document.getElementById('roomNameCreator').value = '';
        });

        document.getElementById('startGameButton').addEventListener('click', function () {
            sendAction('B')
        });

        document.getElementById('EndGameButton').addEventListener('click', function () {
            sendAction('D')
        });

        document.getElementById('sendLetter').addEventListener('click', function () {
            var letter = document.getElementById('letterInput').value; // Get the value of letterInput
            sendActionLetter('C', letter)
            document.getElementById('letterInput').value = ''; // Clear the value of letterInput
        });


        socket.onmessage = function (event) {
            var reader = new FileReader();
            reader.onload = function () {
                try {
                    var sign = reader.result.charAt(0);
                    console.log(reader.result)
                    console.log(sign);
                    if (sign === 'M') {
                        var message = reader.result.substring(1);
                        alert(message);
                    } else if (sign === 'A') {
                        var action = reader.result.charAt(1);
                        var result = reader.result.substring(2);
                        var data = JSON.parse(result);
                        data = JSON.parse(data);
                        if (action === 'C') { // If the server sends a B action
                            document.getElementById('startGameButton').style.display = 'block';  // Show the Start Game button
                        } else if (action === 'R') {
                            roomList.innerHTML = '';
                            for (var room in data.rooms) {
                                var listItem = document.createElement('li');
                                listItem.textContent = room + ': ' + data.rooms[room] + ' players';

                                var joinButton = document.createElement('button');
                                joinButton.textContent = 'Join';
                                joinButton.addEventListener('click', function () {
                                    sendActionRoomData('J', room);
                                });

                                listItem.appendChild(joinButton);
                                roomList.appendChild(listItem);
                            }
                        } else if (action === 'A') {
                            document.getElementById('roomCreator').style.display = 'none';
                            document.getElementById('roomView').style.display = 'block';
                            document.getElementById('roomNameView').textContent = 'Room name: ' + data.room_name;
                            document.getElementById('players').textContent = data.players + '/' + data.max_players + ' players';
                        } else if (action === 'U') {
                            document.getElementById('players').textContent = data.players + '/' + data.max_players + ' players';
                        } else if (action === 'S') {
                            document.getElementById('startGameButton').style.display = 'none';
                            document.getElementById('roomView').style.display = 'none';
                            document.getElementById('gameView').style.display = 'block';
                            document.getElementById('wordProgress').textContent = 'Word: ' + data.wordProgress;
                            document.getElementById('wrongLetters').textContent = 'Wrong letters: ';
                            document.getElementById('letterInput').style.display = 'block';
                            resetHangman();
                            drawHangman(0);
                        } else if (action === 'P') {
                            document.getElementById('wordProgress').textContent = 'Word: ' + data.wordProgress;
                        } else if (action === 'M') {
                            document.getElementById('wrongLetters').textContent = 'Wrong letters: ' + data.wrongLetters;
                            drawHangman(data.errors);
                        } else if (action === 'Y') {
                            document.getElementById('W').style.display = 'none';
                            document.getElementById('letters').style.display = 'block';
                        } else if (action === 'W') {
                            document.getElementById('W').style.display = 'block';
                            document.getElementById('letters').style.display = 'none';
                        }
                        else if (action === 'L') {
                            document.getElementById('gameView').style.display = 'none';
                            document.getElementById('EndGame').style.display = 'block';
                            document.getElementById('EndGameMessage').textContent = 'Hangman! The word was: ' + data.word + '. Better luck next time!';
                        }
                        else if (action === 'V') {
                            document.getElementById('gameView').style.display = 'none';
                            document.getElementById('EndGame').style.display = 'block';
                            document.getElementById('EndGameMessage').textContent = 'Congratulations! You won! The word was: ' + data.word;
                        }
                        else if (action === 'E') {
                            document.getElementById('EndGame').style.display = 'none';
                            document.getElementById('roomCreator').style.display = 'block';
                        }
                    }
                } catch (e) {
                    console.log(e)

                }
            }
            reader.readAsText(event.data);

            socket.onopen = function () {
                sendAction('G');
            };
        };

        function sendAction(action) {
            const sign = 'A';
            const signCharCode = sign.charCodeAt(0);
            const actionCharCode = action.charCodeAt(0);

            const buffer = new ArrayBuffer(3);
            const view = new DataView(buffer);
            view.setUint8(0, signCharCode);
            view.setUint8(1, actionCharCode);

            socket.send(buffer);
        }

        function sendActionRoomData(action, roomName) {
            const sign = 'A';
            const signCharCode = sign.charCodeAt(0);
            const actionCharCode = action.charCodeAt(0);

            const buffer = new ArrayBuffer(18);
            const view = new DataView(buffer);
            view.setUint8(0, signCharCode);
            view.setUint8(1, actionCharCode);
            view.setUint8(2, roomName.length);
            for (let i = 0; i < roomName.length; i++) {
                view.setUint8(3 + i, roomName.charCodeAt(i));
            }


            socket.send(buffer);
        }

        function sendActionLetter(action, letter) {
            const sign = 'A';
            const signCharCode = sign.charCodeAt(0);
            const actionCharCode = action.charCodeAt(0);
            const letterCharCode = letter.charCodeAt(0);

            const buffer = new ArrayBuffer(3);
            const view = new DataView(buffer);
            view.setUint8(0, signCharCode);
            view.setUint8(1, actionCharCode);
            view.setUint8(2, letterCharCode);

            socket.send(buffer);
        }
        function resetHangman() {
            var c = document.getElementById("hangmanCanvas");
            var ctx = c.getContext("2d");
            ctx.clearRect(0, 0, c.width, c.height);
        }

        function drawHangman(errors) {
            var c = document.getElementById("hangmanCanvas");
            var ctx = c.getContext("2d");

            ctx.beginPath();
            // Draw the gallows
            ctx.moveTo(50, 180);
            ctx.lineTo(150, 180);
            ctx.moveTo(100, 180);
            ctx.lineTo(100, 50);
            ctx.lineTo(150, 50);
            ctx.lineTo(150, 70);

            if (errors > 0) {
                // Draw the head
                ctx.arc(150, 90, 20, 0, 2 * Math.PI);
            }
            if (errors > 1) {
                // Draw the body
                ctx.moveTo(150, 110);
                ctx.lineTo(150, 140);
            }
            if (errors > 2) {
                // Draw the first arm
                ctx.moveTo(150, 120);
                ctx.lineTo(130, 110);
            }
            if (errors > 3) {
                // Draw the second arm
                ctx.moveTo(150, 120);
                ctx.lineTo(170, 110);
            }
            if (errors > 4) {
                // Draw the first leg
                ctx.moveTo(150, 140);
                ctx.lineTo(130, 160);
            }
            if (errors > 5) {
                // Draw the second leg
                ctx.moveTo(150, 140);
                ctx.lineTo(170, 160);
            }

            ctx.stroke();
        }
    </script>
</body>

</html>